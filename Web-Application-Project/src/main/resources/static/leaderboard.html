<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leaderboard - TypeMaster</title>
    <style>
      :root {
        --bg: #071022;
        --panel: #0f1724;
        --accent: #d40016;
        --muted: #98a0b3;
        --card-shadow: rgba(2, 6, 23, 0.6);
        --success: #3ddc84;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(
            800px 400px at 10% 10%,
            rgba(12, 18, 35, 0.6),
            transparent
          ),
          linear-gradient(180deg, #071022 0%, #071827 100%);
        color: #e6eef8;
        font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
      }
      .container {
        width: 100%;
        max-width: 900px;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 12px 40px var(--card-shadow);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      h1 {
        margin: 0;
        color: var(--accent);
        font-size: 20px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        background: transparent;
        color: var(--muted);
        border: 1px solid transparent;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #b00012);
        color: white;
        font-weight: 600;
        border: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel);
        border-radius: 8px;
        overflow: hidden;
        margin-top: 12px;
      }
      thead th {
        text-align: left;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        color: var(--accent);
        font-size: 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
      }
      tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        color: #e6eef8;
        font-size: 14px;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.01);
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .rank {
        font-weight: 700;
        color: var(--muted);
      }
      .score {
        color: var(--success);
        font-weight: 700;
      }
      .center {
        text-align: center;
        padding: 18px;
        color: var(--muted);
        font-size: 14px;
      }
      .spinner {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.06);
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @media (max-width: 640px) {
        tbody td {
          padding: 10px;
          font-size: 13px;
        }
        thead th {
          padding: 10px;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <header>
          <div>
            <h1>TypeMaster — Leaderboard</h1>
            <div class="sub">Top WPM scores from players</div>
          </div>
          <div class="controls">
            <button class="btn" onclick="goBack()">← Back to Game</button
            ><button
              class="btn primary"
              id="refreshBtn"
              onclick="loadLeaderboard()"
            >
              Refresh
            </button>
          </div>
        </header>

        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>WPM Score</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="scoreBody">
            <tr>
              <td colspan="4" class="center">Loading...</td>
            </tr>
          </tbody>
        </table>
        <div
          id="errorBox"
          class="center muted"
          style="display: none; margin-top: 12px"
        ></div>
      </div>
    </div>

    <script>
      const API_BASE = "";
      const leaderboardEndpoint = `${API_BASE}/scores/leader-board?top=10`;
      const token = localStorage.getItem("jwt_token");

      function goBack() {
        window.location.href = "/game.html";
      }

      function extractScores(resp) {
        if (!resp) return [];
        if (Array.isArray(resp)) return resp;
        return resp.scoreDTOs || resp.scores || resp.data || resp.result || [];
      }

      function extractUsername(item) {
        if (!item) return "Unknown";
        if (item.user)
          return (
            item.user.username ||
            item.user.fullName ||
            item.user.email ||
            "User"
          );
        return item.username || item.userName || "User#" + (item.userId || "");
      }

      function extractDate(item) {
        return item.createdAt || item.created || item.timestamp || "";
      }

      async function loadLeaderboard() {
        const tbody = document.getElementById("scoreBody");
        const refreshBtn = document.getElementById("refreshBtn");
        tbody.innerHTML = `<tr><td colspan="4" class="center">Loading...</td></tr>`;
        refreshBtn.disabled = true;
        try {
          const headers = { Accept: "application/json" };
          if (token) headers["Authorization"] = `Bearer ${token}`;
          const res = await fetch(leaderboardEndpoint, {
            method: "GET",
            headers,
          });
          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            document.getElementById("errorBox").style.display = "block";
            document.getElementById(
              "errorBox"
            ).textContent = `Failed to load: ${res.status}`;
            tbody.innerHTML = `<tr><td colspan="4" class="center">Unable to load scores</td></tr>`;
            return;
          }
          const data = await res.json().catch(() => null);
          const scores = extractScores(data);
          if (!scores.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="center">No scores yet</td></tr>`;
            return;
          }
          tbody.innerHTML = "";
          scores.forEach((s, i) => {
            const username = extractUsername(s);
            const scoreVal = s.score ?? s.wpm ?? s.points ?? "--";
            const dateText = extractDate(s);
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="rank">#${
              i + 1
            }</td><td>${username}</td><td class="score">${scoreVal}</td><td>${dateText}</td>`;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Network error", err);
          document.getElementById(
            "scoreBody"
          ).innerHTML = `<tr><td colspan="4" class="center">Error connecting to server</td></tr>`;
          document.getElementById("errorBox").style.display = "block";
          document.getElementById("errorBox").textContent =
            "Network error — check server/CORS";
        } finally {
          refreshBtn.disabled = false;
        }
      }

      window.addEventListener("load", loadLeaderboard);
    </script>
  </body>
</html>
